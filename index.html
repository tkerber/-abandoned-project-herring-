<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Simple markers</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script>

var connsSparql = ([
"SELECT ?school_lat ?school_long ?data_lat ?data_long ?strength",
"WHERE{",
"  ?school <http://data.ordnancesurvey.co.uk/ontology/postcode/postcode> ?pc.",
"  ?pc <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?school_lat.",
"  ?pc <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?school_long.",
"  ?zone <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?data_lat.",
"  ?zone <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?data_long.",
"  ?nop <http://data.opendatascotland.org/def/education/numberOfPupils> ?strength.",
"  ?nop <http://data.opendatascotland.org/def/statistical-dimensions/education/school> ?school.",
"  ?nop <http://data.opendatascotland.org/def/statistical-dimensions/refArea> ?zone.",
"  ?school <http://data.opendatascotland.org/def/education/department> ?dep.",
"  ?dep <http://data.opendatascotland.org/def/education/stageOfEducation> <http://data.opendatascotland.org/def/concept/education/stages-of-education/secondary>.",
"}"]).join("\n");

var connsUrl = "http://data.opendatascotland.org/sparql.csv?query=" + encodeURIComponent(connsSparql);

var schoolsSparql = ([
"SELECT ?lat ?long (SUM (?nop) as ?size)",
"WHERE{",
"  ?school <http://data.ordnancesurvey.co.uk/ontology/postcode/postcode> ?pc.",
"  ?pc <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?lat.",
"  ?pc <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?long.",
"  GRAPH <http://data.opendatascotland.org/graph/education/pupils-by-school-and-datazone>{",
"    ?x <http://data.opendatascotland.org/def/statistical-dimensions/education/school> ?school.",
"    ?x <http://data.opendatascotland.org/def/education/numberOfPupils> ?nop.",
"  }",
"  ?school <http://data.opendatascotland.org/def/education/department> ?dep.",
"  ?dep <http://data.opendatascotland.org/def/education/stageOfEducation> <http://data.opendatascotland.org/def/concept/education/stages-of-education/secondary>.",
"}",
"GROUP BY ?lat ?long ?size"]).join("\n");

var schoolsUrl = "http://data.opendatascotland.org/sparql.csv?query=" + encodeURIComponent(schoolsSparql);

$.ajax({
  dataType: 'text',
  url: connsUrl,
  success: function(data){
    data = data.split("\n");
    //console.log(data);
    drawConns(data);
  }
});

$.ajax({
  dataType: 'text',
  url: schoolsUrl,
  success: function(data){
    data = data.split("\n");
    drawSchools(data);
  }
});

function drawSchools(data){
  for(var i = 1; i < data.length; i++){
    var row = data[i].split(',');
    drawSchool(map, new google.maps.LatLng(parseFloat(row[0]), parseFloat(row[1])), parseInt(row[2]));
  }
}

function drawConns(data){
  for(var i = 1; i < data.length; i++){
    var row = data[i].split(',');
    var str = parseInt(row[4]);
    if(str <= 10)
      continue;
    str = Math.log(str);
    drawPath(map, new google.maps.LatLng(parseFloat(row[2]), parseFloat(row[3])), new google.maps.LatLng(parseFloat(row[0]), parseFloat(row[1])), 1.0 , Math.min(1.0, (str - 2)/2));
  }
}
var map;
  
function initialize() {
  var centerLatlng = new google.maps.LatLng(56.632064,-3.729858);
  var mapOptions = {
    zoom: 7,
    center: centerLatlng
  }
  
  var mapDiv = document.getElementById('map-canvas');
  map = new google.maps.Map(mapDiv, mapOptions);
  
  
  var x = new google.maps.LatLng(-24.363882, 130.044922);
  
}

function drawPath(LatSchool, LongSchool, LatDataZone, LongDataZone) {
  drawPath(map, new google.maps.LatLng(LatSchool, LongSchool),
			new google.maps.LatLng(LatDataZone, LongDataZone)
  );
}

function drawPath(map, LatLongDataZone, LatLongSchool, weight, opacity) {
  var options = {
    path: [LatLongDataZone, LatLongSchool],
    strokeOpacity: opacity,
    strokeWeight: weight,
    icons: [{
      offset: '100%'
    }],
    map: map
  };
  
  var line = new google.maps.Polyline(options);
  return line;
} 

function drawSchool(map, LatSchool, LongSchool, students) {
  drawSchool(map,
			 new google.maps.LatLng(LatSchool, LongSchool),
			 students
  );
}

function drawSchool(map, LatLongSchool, students) {
  var options = {
    strokeColor: '#FF0000',
    strokeOpacity: 0.8,
    strokeWeight: 2,
    fillColor: '#FF0000',
    fillOpacity: 0.35,
    map: map,
    center: LatLongSchool,
    radius: (Math.sqrt(students) * 10)
  };
  
  var circ = new google.maps.Circle(options);
  return circ;
}

//on load, run initialize
google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
  </body>
</html>
