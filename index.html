<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Simple markers</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script>

var connsSparql = ([
"SELECT ?school_lat ?school_long ?data_lat ?data_long ?strength",
"WHERE{",
"  ?school <http://data.ordnancesurvey.co.uk/ontology/postcode/postcode> ?pc.",
"  ?pc <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?school_lat.",
"  ?pc <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?school_long.",
"  ?zone <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?data_lat.",
"  ?zone <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?data_long.",
"  ?nop <http://data.opendatascotland.org/def/education/numberOfPupils> ?strength.",
"  ?nop <http://data.opendatascotland.org/def/statistical-dimensions/education/school> ?school.",
"  ?nop <http://data.opendatascotland.org/def/statistical-dimensions/refArea> ?zone.",
"  ?school <http://data.opendatascotland.org/def/education/department> ?dep.",
"  ?dep <http://data.opendatascotland.org/def/education/stageOfEducation> <http://data.opendatascotland.org/def/concept/education/stages-of-education/secondary>.",
"}"]).join("\n");

var connsUrl = "http://data.opendatascotland.org/sparql.csv?query=" + encodeURIComponent(connsSparql);

var schoolsSparql = ([
"SELECT ?name ?lat ?long (SUM (?nop) as ?size)",
"WHERE{",
"  ?school <http://data.ordnancesurvey.co.uk/ontology/postcode/postcode> ?pc.",
"  ?pc <http://www.w3.org/2003/01/geo/wgs84_pos#lat> ?lat.",
"  ?pc <http://www.w3.org/2003/01/geo/wgs84_pos#long> ?long.",
"  ?school <http://www.w3.org/2000/01/rdf-schema#label> ?name.",
"  GRAPH <http://data.opendatascotland.org/graph/education/pupils-by-school-and-datazone>{",
"    ?x <http://data.opendatascotland.org/def/statistical-dimensions/education/school> ?school.",
"    ?x <http://data.opendatascotland.org/def/education/numberOfPupils> ?nop.",
"  }",
"  ?school <http://data.opendatascotland.org/def/education/department> ?dep.",
"  ?dep <http://data.opendatascotland.org/def/education/stageOfEducation> <http://data.opendatascotland.org/def/concept/education/stages-of-education/secondary>.",
"}",
"GROUP BY ?name ?lat ?long ?size"]).join("\n");

var schoolsUrl = "http://data.opendatascotland.org/sparql.csv?query=" + encodeURIComponent(schoolsSparql);

var conns = [];
var schools = [];

$.ajax({
  dataType: 'text',
  url: connsUrl,
  success: function(data){
    data = data.split("\n");
    for(var i = 1; i < data.length; i++){
      var row = data[i].split(',');
      conns.push({
        'schoolLatLong': new google.maps.LatLng(parseFloat(row[0]),
            parseFloat(row[1])),
        'zoneLatLong': new google.maps.LatLng(parseFloat(row[2]),
            parseFloat(row[3])),
        'strength': parseInt(row[4])
      });
    }
    drawConns();
  }
});

$.ajax({
  dataType: 'text',
  url: schoolsUrl,
  success: function(data){
    data = data.split("\n");
    for(var i = 1; i < data.length; i++){
      var row = data[i].split(',');
      schools.push({
        'name': row[0],
        'latLong': new google.maps.LatLng(parseFloat(row[1]),
            parseFloat(row[2])),
        'size': parseInt(row[3])
      });
    }
    console.log(schools);
    drawSchools();
  }
});

function drawSchools(data){
  for(var i = 0; i < schools.length; i++){
    drawSchool(map, schools[i].latLong, schools[i].size, schools[i].name);
  }
}

function drawConns(data){
  for(var i = 0; i < conns.length; i++){
    if(conns[i].strength < 10)
      continue;
    drawPath(map, conns[i].zoneLatLong, conns[i].schoolLatLong,
        Math.min(1.0, (Math.log(conns[i].strength) - 2) / 2));
  }
}
var map;

var mapStyles = [ { "featureType": "poi", "stylers": [ { "weight": 1.9 }, { "visibility": "off" } ] },{ "featureType": "poi.school", "stylers": [ { "visibility": "on" } ] },{ "featureType": "landscape.man_made", "stylers": [ { "visibility": "on" } ] },{ "featureType": "landscape.natural", "stylers": [ { "visibility": "off" } ] } ] ;
  
function initialize() {
  var centerLatlng = new google.maps.LatLng(56.632064,-3.729858);
  var mapOptions = {
    zoom: 7,
    center: centerLatlng,
    mapTypeControlOptions: {
        mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
      }
  };
  
  var mapDiv = document.getElementById('map-canvas');
  map = new google.maps.Map(mapDiv, mapOptions);
  
  map.setOptions({styles : mapStyles})
  var x = new google.maps.LatLng(-24.363882, 130.044922);
  
  var defStyle = [{}]
 
  var styledMap = new google.maps.StyledMapType(defStyle,
		    {name: "Default"});
  map.mapTypes.set('map_style', styledMap);


  
}

function drawPath(LatSchool, LongSchool, LatDataZone, LongDataZone) {
  drawPath(map, new google.maps.LatLng(LatSchool, LongSchool),
			new google.maps.LatLng(LatDataZone, LongDataZone)
  );
}

function drawPath(map, LatLongDataZone, LatLongSchool, weight, opacity) {
  var options = {
    path: [LatLongDataZone, LatLongSchool],
    strokeOpacity: opacity,
    strokeWeight: weight,
    icons: [{
      offset: '100%'
    }],
    map: map
  };
  
  var line = new google.maps.Polyline(options);
  return line;
} 

function drawSchool(map, LatSchool, LongSchool, students) {
  drawSchool(map,
			 new google.maps.LatLng(LatSchool, LongSchool),
			 students
  );
}

function drawSchool(map, LatLongSchool, students, name) {
  var options = {
    position: LatLongSchool,
	map: map,
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      strokeColor: 'ff0000',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: 'ff0000',
      fillOpacity: 0.35,
      scale: (Math.sqrt(students) / 5)
    }
  };

  var circ = new google.maps.Marker(options);
  
  var infowindow = new google.maps.InfoWindow({
    content: '<p><b>' + name + '</b></p>',
    position : circ.position
  });
  
  google.maps.event.addListener(circ, 'mouseover', function() {
    infowindow.open(map);
  });

  google.maps.event.addListener(circ, 'mouseout', function() {
    infowindow.close();
  });
  
  return circ;
}

//on load, run initialize
google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
  </body>
</html>